---
title: "In Lab experiment"
author: "Oscar Feng-Hsun Chang"
date: "2017 Aug. 28"
output: 
  html_document:
    code_folding: show
    highlight: textmate
    keep_md: yes
    number_sections: false
    theme: flatly
    toc: yes
    toc_float:
      collapsed: false
      smooth_scroll: true
      toc_depth: 4
---
        
```{r, include=FALSE, warning=FALSE, messssage=FALSE}
library(MASS)
library(faraway)
library(lme4)
library(nlme)
library(ggplot2)
library(plyr)
library(magrittr)
library(reshape2)
library(dunn.test)
library(cowplot)
```

```{r, data cleaning, echo=FALSE}
#https://raw.githubusercontent.com/OscarFHC/IGP_LabExp/master/Analysis
dat=read.table(file="D:/Research/IGP_LabExp/Analysis/IGP_II_20170419_1.csv", sep=",",header=T,fill=T)
dat[,2:ncol(dat)] = dat[,2:ncol(dat)]+0.01

dat.l = dat %>%
  melt(id="hr", variable.name="trmt", value.name="den") %>%
  mutate(trmt.all = 0)

dat.l[which(grepl("B00", as.character(dat.l[,"trmt"]))==TRUE),"trmt.all"]="B00"
dat.l[which(grepl("C00", as.character(dat.l[,"trmt"]))==TRUE),"trmt.all"]="C00"
dat.l[which(grepl("B02", as.character(dat.l[,"trmt"]))==TRUE),"trmt.all"]="B02"
dat.l[which(grepl("C02", as.character(dat.l[,"trmt"]))==TRUE),"trmt.all"]="C02"
dat.l[which(grepl("B04", as.character(dat.l[,"trmt"]))==TRUE),"trmt.all"]="B04"
dat.l[which(grepl("C04", as.character(dat.l[,"trmt"]))==TRUE),"trmt.all"]="C04"
dat.l[which(grepl("B06", as.character(dat.l[,"trmt"]))==TRUE),"trmt.all"]="B06"
dat.l[which(grepl("C06", as.character(dat.l[,"trmt"]))==TRUE),"trmt.all"]="C06"
dat.l[which(grepl("B08", as.character(dat.l[,"trmt"]))==TRUE),"trmt.all"]="B08"
dat.l[which(grepl("C08", as.character(dat.l[,"trmt"]))==TRUE),"trmt.all"]="C08"
dat.l[which(grepl("B10", as.character(dat.l[,"trmt"]))==TRUE),"trmt.all"]="B10"
dat.l[which(grepl("C10", as.character(dat.l[,"trmt"]))==TRUE),"trmt.all"]="C10"

NonParam_log = function(den){ # This function log transforms the daa when calculatingnon-parametric SE
  set.seed(1032)
  means = replicate(5000, mean(log(sample(den, size=length(den), replace=TRUE))))
  sd(means)
}

dat.summary = dat.l %>%
  ddply(c("trmt.all", "hr"), summarize,
        rep = length(den),
        avg = log(mean(den)),
        sd = sd(log(den)),
        se = sd/sqrt(rep),
        se_permu = NonParam_log(den)
        )
B_sum = dat.summary[which(grepl("B", as.character(dat.summary[,"trmt.all"]))==TRUE),]
C_sum = dat.summary[which(grepl("C", as.character(dat.summary[,"trmt.all"]))==TRUE),]
```

Based on the classic paper by Holling in 1959, predator-prey interaction can be modeled by the following functions (i.e. so called Type I or Type II functional response). Both functional responses contains a parameter that describes the proportion of prey that is available for the predator. 
1. Type I functional response:  

$$f(R) = {\alpha}TR $$, where ${\alpha}$ is the encounter probability, $T$ is the searching time, and $R$ is the prey density. Encounter probability (${\alpha}$) is the proportion of prey that is available for the predator.  

2. Type II functional response:  

$$f(R) = \frac{{\alpha}TR}{1+{\alpha}hR}$$, where ${\alpha}$ is again the encounter probability, $T$ is the searching time, and $h$ is the handling time. 

In my lab experiment, I directly modified the ${\alpha}$ parameter because I used the screen mesh to modify the proportion of IG prey that is available to the IG predator. This lab experiment would thus be valid to verify my model predictions. 

# Population dynamics visualization

First visualize the population dynamics of the two protozoa species.  

*Blepharisma*

```{r, time series visualization for Blespharisma, echo=FALSE}
ggplot(B_sum, aes(x=hr, y=avg, colour=trmt.all)) + 
  geom_errorbar(aes(ymin=avg-se_permu, ymax=avg+se_permu), width=.1) +
  geom_line(aes(group=trmt.all)) +
  geom_point(size=4) + 
  labs(x="hr",
       y="Log[density(ind./mL)]",
       title=expression("Average density of "* italic("Blespharisma")* " across time"),
       caption="error bars represent standard error of the mean") + 
  theme_bw() +
  theme(panel.border = element_blank(), panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), 
        axis.text=element_text(size=16), axis.title=element_text(size=18,face="bold"),
        legend.key=element_rect(color="white", fill="white"), 
        legend.title=element_text(size=14),
        legend.text=element_text(size=14)
        )+
  scale_colour_hue(l=45)
```

*Colpidium*

```{r, time series visualization for Colpidium, echo=FALSE}
ggplot(C_sum, aes(x=hr, y=avg, colour=trmt.all)) + 
  geom_errorbar(aes(ymin=avg-se_permu, ymax=avg+se_permu), width=.1) +
  geom_line(aes(group=trmt.all)) +
  geom_point(size=4) + 
  labs(x="hr",
       y="Log[density(ind./mL)]",
       title=expression("Average density of "* italic("Colpidium")* " across time"),
       caption="error bars represent standard error of the mean")  + 
  theme_bw() +
  theme(panel.border = element_blank(), panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), 
        axis.text=element_text(size=16), axis.title=element_text(size=18,face="bold"),
        legend.key=element_rect(color="white", fill="white"), 
        legend.title=element_text(size=14),
        legend.text=element_text(size=14)
  )+
  scale_colour_hue(l=45)
```

For both *Blespharisma* and *Colpidium*, I calculated the mean density for all six treatments (0%, 20%, 40%, 60%, 80% and 100% encounter probability) at the steady state. Because I cannot be 100% sure what are the most representative time points for the steady state, I calculate the mean density of every five consecutive time points. I then moved this five-point time frame gradually forward from hour 34 to hour 535. Finally , I chose the time frame of  hour 320 to 486 sicne the other time frames are qualitively the same.

# Model predictions

From the model I derive three major predictions. 

## 1. IG prey 

### Model prediction

According to the model, IG prey should monotoncally decrease with IGP strength (encounter probability).

![IG prey density at equilibrium in the model](D:/Research/IGP_LabExp/Analysis/progressReport_20170828/IGPrey_IGPrate_Mod.tiff)

### Experimental results 

```{r, producint series of plots of Colpidium density across 5 time points, echo=FALSE, eval=FALSE}
tp_start = 2
tp_end = length(unique(C_sum[,"hr"]))-2
timepoint = unique(C_sum[,"hr"])[tp_start:tp_end]

path=expression("D:/Research/IGP_LabExp/Analysis/progressReport_20170828")

NonParam_log = function(den){ # This function takes log-transformed data
  set.seed(1032)
  means = replicate(5000, mean(sample(den, size=length(den), replace=TRUE)))
  sd(means)
}

for (i in 1: tp_end){
  if (i+4<=13){
    C_stat = C_sum %>% 
      subset(hr %in% timepoint[i:(i+4)]) %>%
      subset(avg>log(0.01)) %>%
      ddply(c("trmt.all"), summarize,
        rep = length(avg),
        avg_trmt = mean(avg),
        sd_trmt = sd(avg),
        se_trmt = sd_trmt/sqrt(rep),
        se_permu = NonParam_log(avg)
        ) %>%
    ggplot(aes(x=trmt.all, y=avg_trmt)) +
      geom_errorbar(aes(ymin=avg_trmt-se_permu, ymax=avg_trmt+se_permu), width=.1) + 
      geom_point(size=4) + 
      labs(x="treatment", 
           y="Log[density(ind./mL)]", 
           title=paste0("Average Density from hour ", timepoint[i], " to hour ",  timepoint[i+4]),
           caption="error bars represent standard error of the mean") + 
      ylim(-4, 6) + 
      theme_bw() +
      theme(panel.border = element_blank(), panel.grid.major = element_blank(), 
            panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), 
            axis.text=element_text(size=14), axis.title=element_text(size=14,face="bold"),
            legend.key=element_rect(color="white", fill="white"), 
            legend.title=element_text(size=14),
            legend.text=element_text(size=14)) 
    ggsave(filename=paste(path, paste("CDen_tp_", i, "_", i+4, ".jpg", sep=""), sep="//"), 
       plot=C_stat, width=35, height=24, units=c("cm"), dpi=600)
  }else{}
}
```

```{r, echo=FALSE}
#Nees to set i to chose the desired time frame here. Now, it's being set to #8 (hr 320 to 486)
i=9

tp_start = 2
tp_end = length(unique(C_sum[,"hr"]))-2
timepoint = unique(C_sum[,"hr"])[tp_start:tp_end]

NonParam = function(den){ # This function does not transform the data when calculating non-parametric SE
  set.seed(1032)
  means = replicate(5000, mean(sample(den, size=length(den), replace=TRUE)))
  sd(means)
}

C_sum %>% 
  subset(hr %in% timepoint[i:(i+4)]) %>%
  subset(avg>log(0.01)) %>%
  ddply(c("trmt.all"), summarize,
        rep = length(avg),
        avg_trmt = mean(avg),
        sd_trmt = sd(avg),
        se_trmt = sd_trmt/sqrt(rep),
        se_permu = NonParam(avg)
        ) %>%
  ggplot(aes(x=trmt.all, y=avg_trmt)) +
    geom_errorbar(aes(ymin=avg_trmt-se_permu, ymax=avg_trmt+se_permu), width=.1) + 
    geom_point(size=2) + 
    labs(x="treatment", 
         y="Log[density(ind./mL)]", 
         title=bquote("Average density of " ~ italic("Colpidium") ~ 
                      "from hour" ~ .(timepoint[i]) ~ " to hour " ~ .(timepoint[i+4])),
         caption="error bars represent standard error of the mean") + 
    ylim(-2, 4.5) + 
    theme_bw() +
    theme(panel.border = element_blank(), panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), 
          axis.text=element_text(size=14), axis.title=element_text(size=14,face="bold"),
          legend.key=element_rect(color="white", fill="white"), 
          legend.title=element_text(size=14),
          legend.text=element_text(size=14)) 
```

### Statistical check

```{r, echo=FALSE}
C_stat = C_sum %>% 
  subset(hr %in% timepoint[i:(i+4)]) %>%
  subset(avg>log(0.01))
mod_C =  kruskal.test(avg~as.factor(trmt.all), data=C_stat)
mod_C
dunn.test(C_stat[,"avg"], 
          C_stat[,"trmt.all"], method="bh")
```

For the *Colpidium*, We see that 0% encounter probability treatment tend to have higher density than the other treatments, although the multiple comparison results show that 80% and 100% encounter probability treatment are the only two treatments that are not statistically different from 0% encounter probability.

From the plot and the statistical test, all treatments has lower *Colpidium* density comparing to the 0% treatment, which is the treatment where two protozoa species engage in only competition. This suggests that *Colpidium* density would be lower as long as intra-guild predation occurs. 

## 2. IG predator 

### Model prediction

In terms of IG predator density, I would expect it to be similar across treatments. From the pilot experiment (see below), I've observed that the density of IG predator (*Blepharisma*) is not affected by the occurrence of intra-guild predation. 

![Population dynamics from pilot experiment](D:/Manuscript/IGP_div effects/proposals/full proposal_dissertation/figs/IG prey and Pred_TS.jpg)

### Experimental results 

```{r, producint series of plots of Blepharisma density across 5 time points, echo=FALSE}
tp_start = 2
tp_end = length(unique(B_sum[,"hr"]))-2
timepoint = unique(B_sum[,"hr"])[tp_start:tp_end]

NonParam_log = function(den){ # This function takes log-transformed data
  set.seed(1032)
  means = replicate(5000, mean(sample(den, size=length(den), replace=TRUE)))
  sd(means)
}

path=expression("D:/Research/IGP_LabExp/Analysis/progressReport_20170828")

for (i in 1: tp_end){
  if (i+4<=13){
    B_stat = B_sum %>% 
      subset(hr %in% timepoint[i:(i+4)]) %>%
      subset(avg>log(0.01)) %>%
      ddply(c("trmt.all"), summarize,
        rep = length(avg),
        avg_trmt = mean(avg),
        sd_trmt = sd(avg),
        se_trmt = sd_trmt/sqrt(rep),
        se_permu = NonParam_log(avg)
        ) %>%
    ggplot(aes(x=trmt.all, y=avg_trmt)) +
      geom_errorbar(aes(ymin=avg_trmt-se_permu, ymax=avg_trmt+se_permu), width=.1) + 
      geom_point(size=4) + 
      labs(x="treatment", 
           y="Log[density(ind./mL)]", 
           title=paste0("Average Density from hour ", timepoint[i], " to hour ",  timepoint[i+4]),
           caption="error bars represent standard error of the mean") + 
      ylim(-4, 6) + 
      theme_bw() +
      theme(panel.border = element_blank(), panel.grid.major = element_blank(), 
            panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), 
            axis.text=element_text(size=14), axis.title=element_text(size=14,face="bold"),
            legend.key=element_rect(color="white", fill="white"), 
            legend.title=element_text(size=14),
            legend.text=element_text(size=14)) 
    ggsave(filename=paste(path, paste("BDen_tp_", i, "_", i+4, ".jpg", sep=""), sep="//"), 
       plot=B_stat, width=35, height=24, units=c("cm"), dpi=600)
  }else{}
}
```

```{r, echo=FALSE}
#Nees to set i to chose the desired time frame here. Now, it's being set to #8 (hr 320 to 486)
i=9

tp_start = 2
tp_end = length(unique(B_sum[,"hr"]))-2
timepoint = unique(B_sum[,"hr"])[tp_start:tp_end]

NonParam = function(den){ # This function does not transform the data when calculating non-parametric SE
  set.seed(1032)
  means = replicate(5000, mean(sample(den, size=length(den), replace=TRUE)))
  sd(means)
}

B_sum %>% 
  subset(hr %in% timepoint[i:(i+4)]) %>%
  subset(avg>log(0.01)) %>%
  ddply(c("trmt.all"), summarize,
        rep = length(avg),
        avg_trmt = mean(avg),
        sd_trmt = sd(avg),
        se_trmt = sd_trmt/sqrt(rep),
        se_permu = NonParam(avg)
        ) %>%
  ggplot(aes(x=trmt.all, y=avg_trmt)) +
    geom_errorbar(aes(ymin=avg_trmt-qnorm(0.975)*se_permu, ymax=avg_trmt+qnorm(0.975)*se_permu), width=.1) + 
    geom_point(size=2) + 
    labs(x="treatment", 
         y="Log[density(ind./mL)]", 
         title=bquote("Average density of " ~ italic("Blesphrisma") ~ 
                      "from hour" ~ .(timepoint[i]) ~ " to hour " ~ .(timepoint[i+4])),
         caption="error bars represent standard error of the mean")+ 
    ylim(-2, 4.5) + 
    theme_bw() +
    theme(panel.border = element_blank(), panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), 
          axis.text=element_text(size=14), axis.title=element_text(size=14,face="bold"),
          legend.key=element_rect(color="white", fill="white"), 
          legend.title=element_text(size=14),
          legend.text=element_text(size=14)) 
```

### Statistical check

```{r, echo=FALSE}
B_stat = B_sum %>% 
  subset(hr %in% timepoint[i:(i+4)]) %>%
  subset(avg>log(0.01))

mod_B =  kruskal.test(avg~as.factor(trmt.all), data=B_stat)
mod_B
dunn.test(B_stat[,"avg"], 
          B_stat[,"trmt.all"], method="bh")
```

The density of 20% encounter probability treatment has significantly higher density than the other treatments (the p-value of Kruskal-Wallis test is `r mod_B$p.value`) and the pair-wise comparison (Dunn's test) also show significant difference between 20% treatment versus other treatments. 

## 3. Bacteria consumption

Now I check the bacteria consumption in different treatments. To calculate bacteria consumption, I first calculate the bacteria density change in each treatment, including the control treatment where two protozoa species are not present. I then compare the bacteria density change in each treatment (i.e. 0%, 20%, 40%, 60%, 80%, 100% encounter probability) to the control treatment to calculate the bacteria consumption in each treatment. 

### Model prediction

According to the mathematical model, I hypothesize that bacteria consumption would first increase and than decrease with intra-guild predation rate (see below). Again, I used the encounter probability between the two protozoa species to represent the intra-guild predation rate. 

![Theoretical model prediction](D:/Research/IGP_LabExp/Analysis/progressReport_20170828/TotZ_IGPrate_Mod.tiff)

### Experimental results 

```{r, reading/cleaning bacteria data, echo=FALSE, include=FALSE}
#D:/Research/IGP_LabExp/Analysis/IGP_II_20170419_bac.csv
Bac_raw = read.table(file="https://raw.githubusercontent.com/OscarFHC/IGP_LabExp/master/Analysis/IGP_II_20170419_bac1.csv",
                     fill=TRUE, header=TRUE, sep=",")

time = rep(c("T0", "Tend"), each=21)
trmt = rep(c(rep(c("00", "02", "04", "06"), each=3), rep(c("08"), each=4), rep(c("10", "ctrl"), each=5)), 2)
trmt2 = rep(c(rep(c("00_", "02_", "04_"), each=5), rep(c("06_"), each=4), rep(c("08_", "10_", "ctrl_"), each=5)), 2) 
replicate = rep(c(rep(seq(1:5), 3), seq(1:4), rep(seq(1:5), 3)),2)

Bac_raw[,"Sample.Name"] = rep(paste0(time, trmt), each=4)

Bac = Bac_raw %>%
  subset(Gate.Name %in% c("culture population", "R1")) %>%
  subset(select=c("Sample.Name", "Gate.Name", "Concentration")) %>%
  mutate(time = rep(time, each=2)) %>%
  mutate(trmt = rep(paste0(trmt2, replicate), each=2))
  colnames(Bac) = c("trmt_all", "pop", "den", "time", "trmt")
Bac[,"den"] = as.numeric(as.character(Bac[,"den"]))

Bac_pop_sum = Bac %>% 
  subset(pop %in% c("culture population")) %>%
  ddply(c("trmt_all"), "summarize",
        rep_n = length(den),
        avg = mean(log(den*10^3)),
        sd = sd(log(den)),
        se = sd/sqrt(rep_n),
        se_permu = NonParam_log(den)
        )

Bac_pop_sum %>%
  subset (trmt_all %in% c("T000", "T002", "T004", "T006", "T008", "T010", "T0ctrl")) %>%
  ggplot(aes(x=trmt_all, y=avg)) +
    geom_errorbar(aes(ymin=avg-se_permu, ymax=avg+se_permu), width=.1) + 
    geom_point(size=4) + 
    xlab("treatment") + 
    ylab(expression(paste("Log[Initial bacteria density (ind./", mu, "L)]"))) + 
    theme_bw() +
    theme(panel.border = element_blank(), panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), 
          axis.text=element_text(size=16), axis.title=element_text(size=18,face="bold"),
          legend.key=element_rect(color="white", fill="white"), 
          legend.title=element_text(size=14),
          legend.text=element_text(size=14)
    ) 
```

```{r, echo=FALSE}
Bac_pop_stat = Bac %>%
  subset(pop %in% c("culture population")) %>%
  dcast(trmt~time, value.var="den") %>%
  mutate(dif=Tend-mean(T0), 
         gp=c(rep(c("00", "02", "04"), each=5), rep(c("06"), each=4), rep(c("08", "10", "ctrl"), each=5))) %>%
  mutate(rep=c(rep(seq(1:5), 3), seq(1:4), rep(seq(1:5), 3)))

ctrl = Bac_pop_stat %>% subset(gp=="ctrl")
dif_ctrl = mean(ctrl[,"dif"])

NonParam = function(den){ # This function does not transform the data when calculating non-parametric SE
  set.seed(1032)
  means = replicate(5000, mean(sample(den, size=length(den), replace=TRUE)))
  sd(means)
}

Bac_pop_stat %>%
  subset(gp!="ctrl") %>%
  ddply(c("gp"), summarize,
    rep_trmt = length(dif),
    avg_trmt = dif_ctrl-mean(dif),
    sd_trmt = sd(dif_ctrl-dif),
    se_trmt = sd_trmt/sqrt(rep_trmt),
    se_permu = NonParam(dif)
    ) %>%
  ggplot(aes(x=gp, y=avg_trmt)) +
    geom_errorbar(aes(ymin=avg_trmt-se_permu, ymax=avg_trmt+se_permu), width=.1) + 
    geom_point(size=4) + 
    labs(x="Treatment", 
         y=expression(paste("Bacteria consumption (ind./", mu, "L)")),
         caption="error bars represent standard error of the mean")+ 
    theme_bw() +
    theme(panel.border = element_blank(), panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), 
          axis.text=element_text(size=16), axis.title=element_text(size=18,face="bold"),
          legend.key=element_rect(color="white", fill="white"), 
          legend.title=element_text(size=14),
          legend.text=element_text(size=14)
    ) 
```

### Statistical check

```{r, echo=FALSE}
Bac_pop_stat = Bac %>%
  subset(pop %in% c("culture population")) %>%
  dcast(trmt~time, value.var="den") %>%
  mutate(dif=Tend-mean(T0), 
         gp=c(rep(c("00", "02", "04"), each=5), rep(c("06"), each=4), rep(c("08", "10", "ctrl"), each=5))) %>%
  mutate(rep=c(rep(seq(1:5), 3), seq(1:4), rep(seq(1:5), 3)))

mod_bac = kruskal.test(dif~as.factor(gp), data=Bac_pop_stat)
dunn.test(Bac_pop_stat[,"dif"], 
          Bac_pop_stat[,"gp"], method="bh")
```

Because all five measurements are not independent, I used mixed model to take into account the potential correlation structure withing each treatment (i.e. the repeat is the random effect).

```{r, echo=FALSE}
mod_bac1 = lmer(dif~as.factor(gp)+(1|rep), data=Bac_pop_stat[which(Bac_pop_stat[,"gp"]!="ctrl"),], REML=FALSE)
coefs = data.frame(coef(summary(mod_bac1)))
# use normal distribution to approximate p-value
coefs[,"p.z"] = 2 * (1 - pnorm(abs(coefs$t.value)))
coefs
```

This mixed effects model reveals that bacteria consumption in competition-only treatment would not be significantly different from 0. Bacteria consumption in 40% encounter probabilty treatment would be significantly higher than that in the competition-only treatment. Bacteria consumption in 80% and 100% encounter probabilty treatments would be significantly lower than the competition-only treatment. 

