---
title: "In Lab experiment"
author: "Oscar Feng-Hsun Chang"
date: "2017 May"
output: 
  html_document:
    code_folding: show
    highlight: textmate
    keep_md: yes
    number_sections: false
    theme: flatly
    toc: yes
    toc_float:
      collapsed: false
      smooth_scroll: true
      toc_depth: 4
---
        
```{r, include=FALSE}
library(MASS)
library(faraway)
library(lme4)
library(nlme)
library(ggplot2)
library(plyr)
library(magrittr)
library(reshape2)
library(dunn.test)
```

```{r, data cleaning, echo=FALSE}
#https://raw.githubusercontent.com/OscarFHC/IGP_LabExp/master/Analysis
dat=read.table(file="D:/Research/IGP_LabExp/Analysis/IGP_II_20170419.csv", sep=",",header=T,fill=T)
dat[,2:ncol(dat)] = dat[,2:ncol(dat)]+0.01

dat.l = dat %>%
  melt(id="hr", variable.name="trmt", value.name="den") %>%
  mutate(trmt.all = 0)

dat.l[which(grepl("B00", as.character(dat.l[,"trmt"]))==TRUE),"trmt.all"]="B00"
dat.l[which(grepl("C00", as.character(dat.l[,"trmt"]))==TRUE),"trmt.all"]="C00"
dat.l[which(grepl("B02", as.character(dat.l[,"trmt"]))==TRUE),"trmt.all"]="B02"
dat.l[which(grepl("C02", as.character(dat.l[,"trmt"]))==TRUE),"trmt.all"]="C02"
dat.l[which(grepl("B04", as.character(dat.l[,"trmt"]))==TRUE),"trmt.all"]="B04"
dat.l[which(grepl("C04", as.character(dat.l[,"trmt"]))==TRUE),"trmt.all"]="C04"
dat.l[which(grepl("B06", as.character(dat.l[,"trmt"]))==TRUE),"trmt.all"]="B06"
dat.l[which(grepl("C06", as.character(dat.l[,"trmt"]))==TRUE),"trmt.all"]="C06"
dat.l[which(grepl("B08", as.character(dat.l[,"trmt"]))==TRUE),"trmt.all"]="B08"
dat.l[which(grepl("C08", as.character(dat.l[,"trmt"]))==TRUE),"trmt.all"]="C08"
dat.l[which(grepl("B10", as.character(dat.l[,"trmt"]))==TRUE),"trmt.all"]="B10"
dat.l[which(grepl("C10", as.character(dat.l[,"trmt"]))==TRUE),"trmt.all"]="C10"

dat.summary = ddply(dat.l, c("trmt.all", "hr"), summarize,
                    rep = length(den),
                    avg = log(mean(den)),
                    sd = sd(log(den)),
                    se = sd/sqrt(rep)
                    )
B_sum = dat.summary[which(grepl("B", as.character(dat.summary[,"trmt.all"]))==TRUE),]
C_sum = dat.summary[which(grepl("C", as.character(dat.summary[,"trmt.all"]))==TRUE),]
```

Based on the classic paper by Holling in 1959, predator-prey interaction can be modeled by the following functions (i.e. so called Type I or Type II functional response). Both functional responses contains a parameter that describes the proportion of prey that is available for the predator.  

1. Type I functional response:  

$$f(R) = {\alpha}TR $$, where ${\alpha}$ is the encounter probability, $T$ is the searching time, and $R$ is the prey density. Encounter probability (${\alpha}$) is the proportion of prey that is available for the predator.  

2. Type II functional response:  

$$f(R) = \frac{{\alpha}TR}{1+{\alpha}hR}$$, where ${\alpha}$ is again the encounter probability, $T$ is the searching time, and $h$ is the handling time. 

In my lab experiment, I directly modified the ${\alpha}$ parameter because I used the screen mesh to modify the proportion of IG prey that is available to the IG predator. This lab experiment would thus be valid to verify my model predictions. 

# Population dynamics visualization

First visualize the population dynamics of the two protozoa species.  

*Blepharisma*

```{r, time series visualization for Blespharisma, echo=FALSE}
ggplot(B_sum, aes(x=hr, y=avg, colour=trmt.all)) + 
  geom_errorbar(aes(ymin=avg-se, ymax=avg+se), width=.1) +
  geom_line(aes(group=trmt.all)) +
  geom_point(size=4) + 
  xlab("hr") + 
  ylab("Log[density(ind./mL)]") + 
  theme_bw() +
  theme(panel.border = element_blank(), panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), 
        axis.text=element_text(size=16), axis.title=element_text(size=18,face="bold"),
        legend.key=element_rect(color="white", fill="white"), 
        legend.title=element_text(size=14),
        legend.text=element_text(size=14)
        )+
  scale_colour_hue(l=45)
```

*Colpidium*

```{r, time series visualization for Colpidium, echo=FALSE}
ggplot(C_sum, aes(x=hr, y=avg, colour=trmt.all)) + 
  geom_errorbar(aes(ymin=avg-se, ymax=avg+se), width=.1) +
  geom_line(aes(group=trmt.all)) +
  geom_point(size=4) + 
  xlab("hr") + 
  ylab("Log[density(ind./mL)]") + 
  theme_bw() +
  theme(panel.border = element_blank(), panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), 
        axis.text=element_text(size=16), axis.title=element_text(size=18,face="bold"),
        legend.key=element_rect(color="white", fill="white"), 
        legend.title=element_text(size=14),
        legend.text=element_text(size=14)
  )+
  scale_colour_hue(l=45)
```

Now I take the hour 368, 414, 468, 486, and 535 to calculate the mean and standard error of two protozoa density in the six treatments (0%, 20%, 40%, 60%, 80%, and 100% encounter probability). 

# Model predictions

From the model I derive three major predictions. 

## 1. IG prey 

### Model prediction

Here I extract the IG prey density at the equilibrium from the model. According to the model that used type I functinoal response to model intra-guild predation, I would expect the IG prey density to monotonically decrease with encounter probability. 

![IG prey density at equilibrium in the model](D:/Research/IGP_LabExp/Analysis/ProgressReport_1/IGprey_IGPrate_Mod.tiff)

### Experimental results 

Here I calculate the mean IG prey (*Colpidium*) density across the six treatments (0%, 20%, 40%, 60%, 80% and 100% encounter probability)

```{r, density of Colpidium, echo=FALSE}
C_stat = C_sum %>%
  subset(hr>350 & hr<550)

C_stat %>%
  ddply(c("trmt.all"), summarize,
        rep = length(avg),
        avg_trmt = mean(avg),
        sd_trmt = sd(avg),
        se_trmt = sd_trmt/sqrt(rep)
        ) %>%
  ggplot(aes(x=trmt.all, y=avg_trmt)) +
    geom_errorbar(aes(ymin=avg_trmt-qnorm(0.975)*se_trmt, ymax=avg_trmt+qnorm(0.975)*se_trmt), width=.1) + 
    geom_point(size=4) + 
    xlab("treatment") + 
    ylab("Log[density(ind./mL)]") + 
    theme_bw() +
    theme(panel.border = element_blank(), panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), 
          axis.text=element_text(size=14), axis.title=element_text(size=14,face="bold"),
          legend.key=element_rect(color="white", fill="white"), 
          legend.title=element_text(size=14),
          legend.text=element_text(size=14)
    ) 
```

The two plots does not match. This mismatch suggests to me that the type I functional response in the model is not proper to describe the population dynamics of IG prey and IG predator. 

## 2. IG predator

### Model prediction

Here I extract the IG predator density at the equilibrium from the model. According to the model that used type I functinoal response to model intra-guild predation, I would expect the IG predator density to monotonically increase with encounter probability. 

![IG predator density at equilibrium in the model](D:/Research/IGP_LabExp/Analysis/ProgressReport_1/IGpred_IGPrate_Mod.tiff)

### Experimental results 

Here I calculate the mean IG predator (*Blepharisma*) density across the six treatments (0%, 20%, 40%, 60%, 80% and 100% encounter probability).

```{r, density of Blepharisma, echo=FALSE}
B_stat = B_sum %>%
  subset(hr>350 & hr<550)

B_stat %>%
  ddply(c("trmt.all"), summarize,
        rep = length(avg),
        avg_trmt = mean(avg),
        sd_trmt = sd(avg),
        se_trmt = sd_trmt/sqrt(rep)
        ) %>%
  ggplot(aes(x=trmt.all, y=avg_trmt)) +
    geom_errorbar(aes(ymin=avg_trmt-qnorm(0.975)*se_trmt, ymax=avg_trmt+qnorm(0.975)*se_trmt), width=.1) + 
    geom_point(size=4) + 
    xlab("treatment") + 
    ylab("Log[density(ind./mL)]") + 
    theme_bw() +
    theme(panel.border = element_blank(), panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), 
          axis.text=element_text(size=14), axis.title=element_text(size=14,face="bold"),
          legend.key=element_rect(color="white", fill="white"), 
          legend.title=element_text(size=14),
          legend.text=element_text(size=14)
    )  

```

The two plots not match agian. This further suggests that type I functional response in my current model should be modified.

## 3. Bacteria consumption

### Model prediction

Here I extract the total consumer density at the equilibrium from the model. Because both IG prey and IG predator consume bacteria with type I functional response, total consumer density is proportional to bacteria consumption. According to the model, I would expect the bacteria consumption to first increase and then decrease with encounter probability. 

![Bacteria consumption at equilibrium in the model](D:/Research/IGP_LabExp/Analysis/ProgressReport_1/TotZ_IGPrate_Mod.tiff)

### Experimental results 

```{r, reading/cleaning bacteria data, echo=FALSE}
#D:/Research/IGP_LabExp/Analysis/IGP_II_20170419_bac.csv
Bac_raw = read.table(file="https://raw.githubusercontent.com/OscarFHC/IGP_LabExp/master/Analysis/IGP_II_20170419_bac.csv",
                     fill=TRUE, header=TRUE, sep=",")

time = rep(c("T0", "Tend"), each=34)
trmt = rep(c(rep(c("00", "02", "04"), each=5), rep(c("06"), each=4), rep(c("08", "10", "ctrl"), each=5)), 2)
trmt2 = rep(c(rep(c("00_", "02_", "04_"), each=5), rep(c("06_"), each=4), rep(c("08_", "10_", "ctrl_"), each=5)), 2) 
replicate = rep(c(rep(seq(1:5), 3), seq(1:4), rep(seq(1:5), 3)),2)

Bac_raw[,"Sample.Name"] = rep(paste0(time, trmt), each=4)

Bac = Bac_raw %>%
  subset(Gate.Name %in% c("culture population", "R1")) %>%
  subset(select=c("Sample.Name", "Gate.Name", "Concentration")) %>%
  mutate(time = rep(time, each=2)) %>%
  mutate(trmt = rep(paste0(trmt2, replicate), each=2))
  colnames(Bac) = c("trmt_all", "pop", "den", "time", "trmt")
Bac[,"den"] = as.numeric(as.character(Bac[,"den"]))

Bac_pop_sum = Bac %>% 
  subset(pop %in% c("culture population")) %>%
  ddply(c("trmt_all"), "summarize",
        rep_n = length(den),
        avg = log10(mean(den)*10^3),
        avg = log(mean(den)),
        sd = sd(log(den)),
        se = sd/sqrt(rep_n)
        )

Bac_pop_stat = Bac %>%
  subset(pop %in% c("culture population")) %>%
  dcast(trmt~time, value.var="den") %>%
  mutate(dif=Tend-mean(T0), 
         gp=c(rep(c("00", "02", "04"), each=5), rep(c("06"), each=4), rep(c("08", "10", "ctrl"), each=5))) %>%
  mutate(rep=c(rep(seq(1:5), 3), seq(1:4), rep(seq(1:5), 3)))
```

```{r, echo=FALSE}
ctrl = Bac_pop_stat %>% subset(gp=="ctrl")
dif_ctrl = mean(ctrl[,"dif"])

Bac_pop_stat %>%
  subset(gp!="ctrl") %>%
  ddply(c("gp"), summarize,
    rep_trmt = length(dif),
    avg_trmt = dif_ctrl-mean(dif),
    sd_trmt = sd(dif_ctrl-dif),
    se_trmt = sd_trmt/sqrt(rep_trmt)
    ) %>%
  ggplot(aes(x=gp, y=avg_trmt)) +
    geom_errorbar(aes(ymin=avg_trmt-se_trmt, ymax=avg_trmt+se_trmt), width=.1) + 
    geom_point(size=4) + 
    xlab("treatment") + 
    ylab(expression(paste("Bacteria consumption (ind./", mu, "L)"))) + 
    theme_bw() +
    theme(panel.border = element_blank(), panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), 
          axis.text=element_text(size=16), axis.title=element_text(size=18,face="bold"),
          legend.key=element_rect(color="white", fill="white"), 
          legend.title=element_text(size=14),
          legend.text=element_text(size=14)
    ) 
  

Bac_R1_sum = Bac %>% 
  subset(pop %in% c("R1")) %>%
  ddply(c("trmt"), summarize,
        rep_n = length(den),
        mean = log(mean(den)),
        sd = sd(log(den)),
        se = sd/sqrt(rep_n)
        )
```

This experimental results match the model prediction. This means that when intermediate proportion of IG prey is accessiable to the IG predator, overall consumption of shared resources would be higher. In addition, we see that when encounter probability is high (i.e. 80% and 100%), bacteria consumption is the lowest. This suggest that in high encounter probability treatments, IG predator is satiated by the IG prey so that shared resources are partly released from the consumption by the IG predator and can accumulate their density. Higher shared resource density in these treatments is the reason why IG prey can have higher density in these treatments.  

From these experimental results, I suspect that in this system, intra-guild predation should be modeled by type II functinoal response along with prey switching behavior. 

# Additional checkes

## 1. Check initial bacteria density.  

First I check if the initial bacteria density across treatments are the same. 

```{r}
Bac_pop_stat %>%
  ddply(c("gp"), summarize,
    rep_trmt = length(T0),
    avg_trmt = mean(T0),
    sd_trmt = sd(T0),
    se_trmt = sd_trmt/sqrt(rep_trmt)
    ) %>%
  ggplot(aes(x=gp, y=avg_trmt)) +
    geom_errorbar(aes(ymin=avg_trmt-qnorm(0.975)*se_trmt, ymax=avg_trmt+qnorm(0.975)*se_trmt), width=.1) + 
    geom_point(size=4) + 
    xlab("treatment") + 
    ylab(expression(paste("Initial bacteria density (ind./", mu, "L)]"))) + 
    theme_bw() +
    theme(panel.border = element_blank(), panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), 
          axis.text=element_text(size=16), axis.title=element_text(size=18,face="bold"),
          legend.key=element_rect(color="white", fill="white"), 
          legend.title=element_text(size=14),
          legend.text=element_text(size=14)
    ) 

mod_Bac_T0 =  kruskal.test(T0~as.factor(gp), data=Bac_pop_stat)
mod_Bac_T0
dunn.test(Bac_pop_stat[,"T0"], 
          Bac_pop_stat[,"gp"], method="bh")
```

The initial bacteria density are not significantly different from each other.  

```{r, eval=FALSE}
mod_B =  kruskal.test(avg~as.factor(trmt.all), data=B_stat)
mod_B
dunn.test(B_stat[,"avg"], 
          B_stat[,"trmt.all"], method="bh")
```

```{r, eval=FALSE}
mod_bac = kruskal.test(dif~as.factor(gp), data=Bac_pop_stat)
mod_bac

summary(mod_bac)
dunn.test(Bac_pop_stat[,"dif"], 
          Bac_pop_stat[,"gp"], method="bh")
```

```{r, eval=FALSE}
Bac_pop_stat[,"gp"] = relevel(as.factor(Bac_pop_stat[,"gp"]), ref="ctrl")
mod_bac1 = lmer(dif~as.factor(gp)+(1|rep), data=Bac_pop_stat, REML=FALSE)
coefs = data.frame(coef(summary(mod_bac1)))
# use normal distribution to approximate p-value
coefs[,"p.z"] = 2 * (1 - pnorm(abs(coefs$t.value)))
coefs
```


